# PC Inventory Client - Windows サービス化セットアップガイド

このガイドでは、PC Inventory Client を Windows サービスとして実行する方法を説明します。

## 目次

1. [概要](#概要)
2. [必要なもの](#必要なもの)
3. [セットアップ手順](#セットアップ手順)
4. [サービスの管理](#サービスの管理)
5. [トラブルシューティング](#トラブルシューティング)
6. [アンインストール](#アンインストール)

## 概要

Windows サービスとして実行することで、以下のメリットがあります：

- **バックグラウンド実行**: タスクバーにウィンドウが表示されず、誤って閉じる心配がありません
- **自動起動**: Windows 起動時に自動的にクライアントが起動します
- **高い安定性**: サービスとして動作するため、より安定した運用が可能です
- **ユーザーログオフ後も動作**: ログオフしてもサービスは動作し続けます

## 必要なもの

### 1. NSSM (Non-Sucking Service Manager)

NSSM は Windows で任意のプログラムをサービス化するためのツールです。

#### ダウンロード方法

1. 公式サイトにアクセス: https://nssm.cc/download
2. 最新版の NSSM をダウンロード（例: `nssm-2.24.zip`）
3. ZIP ファイルを解凍
4. `win64` フォルダ内の `nssm.exe` を取得
5. **重要**: `nssm.exe` を本クライアントフォルダ（`pc-inventory-client.exe` と同じ場所）にコピー

### 2. 管理者権限

サービスのインストール・管理には Windows の管理者権限が必要です。

## セットアップ手順

### ステップ 1: NSSM の配置

```
releases/client/
├── pc-inventory-client.exe
├── config.toml
├── nssm.exe              ← ここに配置
├── install_service.bat
└── ...
```

### ステップ 2: 設定ファイルの確認

`config.toml` が正しく設定されていることを確認します。
存在しない場合は `config.toml.template` をコピーして編集してください。

### ステップ 3: サービスのインストール

1. `install_service.bat` を **右クリック**
2. **「管理者として実行」** を選択
3. スクリプトが実行され、以下の処理が行われます：
   - サービス名: `PCInventoryClient` として登録
   - 表示名: `PC Inventory Client`
   - 起動タイプ: 自動（Windows 起動時に自動起動）
   - ログファイル: `client.log` および `client_error.log`
   - ログローテーション: 10MB ごとに自動ローテーション
   - 障害時の動作: 10秒後に自動再起動

### ステップ 4: サービスの起動

以下のいずれかの方法でサービスを起動します：

**方法 1: バッチファイルを使用**
```
start_service.bat を右クリック → 「管理者として実行」
```

**方法 2: コマンドラインを使用**
```cmd
net start PCInventoryClient
```

**方法 3: Windows サービスマネージャーを使用**
1. `Win + R` を押して「`services.msc`」を実行
2. 「PC Inventory Client」を探す
3. 右クリック → 「開始」

## サービスの管理

以下のバッチファイルを使用してサービスを管理できます（すべて管理者として実行）：

| ファイル名 | 説明 |
|-----------|------|
| `install_service.bat` | サービスをインストール |
| `uninstall_service.bat` | サービスをアンインストール |
| `start_service.bat` | サービスを開始 |
| `stop_service.bat` | サービスを停止 |
| `restart_service.bat` | サービスを再起動（設定変更後など） |
| `status_service.bat` | サービスの状態を確認 |

### サービスの状態確認

**タスクマネージャーで確認:**
1. `Ctrl + Shift + Esc` でタスクマネージャーを開く
2. 「詳細」タブまたは「サービス」タブを開く
3. `PCInventoryClient` または `pc-inventory-client.exe` を探す

**サービスマネージャーで確認:**
1. `Win + R` → `services.msc` を実行
2. 「PC Inventory Client」を探す
3. 状態が「実行中」になっていることを確認

### ログの確認

サービスのログは以下のファイルに出力されます：

- `client.log` - 標準出力ログ
- `client_error.log` - エラーログ

## トラブルシューティング

### サービスが起動しない

1. **設定ファイルを確認**
   - `config.toml` が正しく設定されているか確認
   - サーバーのアドレスとポートが正しいか確認
   - `user_name` が設定されているか確認

2. **ログファイルを確認**
   ```
   client_error.log を開いてエラー内容を確認
   ```

3. **サーバーへの接続を確認**
   - サーバーが起動しているか確認
   - ネットワーク接続を確認
   - ファイアウォール設定を確認

### サービスがすぐに停止する

1. `client_error.log` でエラー内容を確認
2. 設定ファイルの内容を見直す
3. 手動実行で動作確認:
   ```cmd
   cd releases\client
   pc-inventory-client.exe
   ```

### サービスを再インストールしたい

1. `uninstall_service.bat` を管理者として実行
2. 問題を修正
3. `install_service.bat` を管理者として実行

## アンインストール

### サービスの削除

1. `uninstall_service.bat` を **右クリック**
2. **「管理者として実行」** を選択
3. サービスが停止され、削除されます

### 完全なアンインストール

サービスを削除した後、必要に応じて以下のファイルも削除できます：

- `client.log`
- `client_error.log`
- `nssm.exe`
- クライアントフォルダ全体

## 補足情報

### サービスの詳細設定

NSSM を使用すると、さらに詳細な設定が可能です：

```cmd
# サービスの編集（GUI）
nssm edit PCInventoryClient

# サービスの設定を表示
nssm dump PCInventoryClient
```

### セキュリティに関する注意

- サービスは SYSTEM アカウントで実行されます
- config.toml に認証情報を含める場合は、ファイルの権限に注意してください
- ログファイルに機密情報が含まれないよう注意してください

### パフォーマンス

- サービスは自動的に再起動するよう設定されています（10秒の遅延）
- ログファイルは 10MB ごとにローテーションされます
- CPU とメモリの使用量は通常非常に低いです

---

**問題が解決しない場合**

システム管理者に連絡するか、以下の情報を添えてサポートに問い合わせてください：
- `client.log` と `client_error.log` の内容
- `config.toml` の内容（機密情報は除く）
- Windows のバージョン
- サービスの状態（`status_service.bat` の出力）
